# UI Inspector アプリ - 設計書

## 1. 概要

Windows デスクトップアプリケーションを作成し、ユーザーが画面上の任意の UI 要素を選択して、その Automation 属性（AutomationId、Name、ControlType など）を取得・表示できるようにします。

## 2. 要件

- **画面選択モード**: ユーザーが要素をホバー/クリックして選択できるモード。
- **属性抽出**: `AutomationId`、`Name`、`ClassName`、`ControlType` などを取得。
- **出力**: コンソール（標準出力）に属性を表示。
- **インタラクション**: クリックしてキャプチャ。

## 3. 技術アーキテクチャ

### 3.1. モジュール構成

`inspector.py`はオーケストレーション層として機能し、以下のモジュールに処理を委譲します：

#### コアモジュール (`src/inspector/core/`)

- **PathGenerator** (`path_generator.py`)
  - RPAパス生成ロジック
  - modern/legacy モード対応
    - **modernモード**: AutomationIdとNameを優先
    - **legacyモード**: ClassNameとfoundIndexを使用
  - 階層化パス生成（親子関係を利用）
  - セグメント生成と最適化

#### ユーティリティモジュール (`src/inspector/utils/`)

- **ClickHandler** (`click_handler.py`)
  - マウス/キーボード入力検出
  - クリックイベント待機
  - ESCキー検出

- **OutputHandler** (`output_handler.py`)
  - 出力処理（CSV/clipboard/alias）
  - ファイル生成（タイムスタンプ付き）
  - クリップボードコピー

### 3.2. 設計原則

- **単一責任原則**: パス生成、入力処理、出力処理を分離
- **拡張性**: 新しい出力形式の追加が容易
- **保守性**: 変更影響範囲の限定
- **テスト容易性**: モジュール単位でテスト可能

### 3.3. ライブラリ

**提案スタック:**

- **`uiautomation` (by yinkaisheng)** または **`pywinauto`**: カーソル下の UI 要素とそのプロパティにアクセスするために使用します。`uiautomation` は直接的な UIA アクセスにおいて高速で堅牢です。
- **`keyboard`**: グローバルキーボードフックに使用（ESC検出）。
- **`ctypes`**: マウス入力検出（GetAsyncKeyState）。

### 3.4. ワークフロー

1.  **起動**: アプリが初期化され、手順を表示します。
2.  **選択モード**:
    - アプリがグローバルマウスリスナーをインストールします。
    - (オプション) カーソル下の要素をリアルタイムでハイライト。
3.  **トリガー**:
    - ユーザーが要素上にマウスを移動します。
    - ユーザーがクリックします（例：左クリック、または通常のクリックを妨げないための Ctrl+Click などのホットキー）。
4.  **キャプチャ & 検査**:
    - クリック時にカーソル位置 `(x, y)` を取得します。
    - `uiautomation.ControlFromPoint(x, y)` を使用して要素を取得します。
    - プロパティを抽出します: `AutomationId`、`Name`、`ControlTypeName`、`ClassName`、`BoundingRectangle`。
5.  **出力**: 整形された JSON またはテキストをコンソールに出力します。
6.  **ループ/終了**: 特定の終了キー（例：Esc）が押されるまでリスニングを継続します。

## 4. 詳細コンポーネント設計

### 4.1. `Inspector` クラス

- **メソッド**:
  - `start_listening()`: `pynput` リスナーをセットアップします。
  - `on_click(x, y, button, pressed)`: マウスイベントのコールバック。
  - `inspect_element(x, y)`: UIA 要素を取得するコアロジック。
  - `display_info(control)`: データを整形して表示します。

### 4.2. 安全性と UX

- **ノンブロッキング**: リスナーは別スレッドで実行されます。
- **終了戦略**: アプリを終了するためのキーボードリスナー（'Esc'）。
- **干渉**: 純粋な左クリックキャプチャは、実際のボタンクリックをトリガーしてしまう可能性があります。
  - _推奨_: ホットキー（例：`F2` または `Ctrl` キー）を使用してカーソル下の要素を「フリーズ」してキャプチャするか、可能であればクリックイベントを抑制します（ただし抑制はリスク/複雑さが伴います）。
  - _代替案_: 「ホバーして待機」または「ホットキーでキャプチャ」。
  - _ユーザー要望_: 「マウスクリック」。クリック検知を実装しますが、副作用（実際のボタンがクリックされる）の可能性について助言します。

## 5. 提案実装手順

1.  環境セットアップ（`uiautomation`、`pynput` のインストール）。
2.  `ControlFromPoint` を使用した `Inspector` クラスの実装。
3.  `pynput` マウスリスナーの追加。
4.  `pynput` キーボードリスナーの追加（終了用）。
5.  出力フォーマットの調整。
